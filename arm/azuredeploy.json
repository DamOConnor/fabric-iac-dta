{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.29.47.4906",
      "templateHash": "15660307206152630162"
    }
  },
  "parameters": {
    "adminEmail": {
      "type": "string",
      "metadata": {
        "description": "The admin email - used in the authorisation for the Logic App"
      }
    },
    "guid": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Unique guid - to help make resource names (like Fabric Capacity names) unique"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location for all resources deployed in this template"
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "F2",
      "metadata": {
        "description": "The Fabric F-SKU size, eg F2, F64 etc"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[toLower(substring(parameters('guid'), 0, 5))]",
    "baseName": "[format('{0}', variables('uniqueSuffix'))]",
    "resourceGroupName": "[format('rg-fabric-{0}', variables('uniqueSuffix'))]",
    "fabricCapacityName": "[format('fab{0}', variables('baseName'))]",
    "logicAppName": "[format('la-pause-fab{0}', variables('baseName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "fab",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminEmail": {
            "value": "[parameters('adminEmail')]"
          },
          "fabricCapacityName": {
            "value": "[variables('fabricCapacityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('sku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "4211307261827339691"
            }
          },
          "parameters": {
            "adminEmail": {
              "type": "string"
            },
            "fabricCapacityName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "allowedValues": [
                "F2",
                "F4",
                "F8",
                "F16",
                "F32",
                "F64",
                "F128",
                "F256",
                "F512",
                "F1024",
                "F2048"
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.Fabric/capacities",
              "apiVersion": "2023-11-01",
              "name": "[parameters('fabricCapacityName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "Fabric"
              },
              "properties": {
                "administration": {
                  "members": [
                    "[parameters('adminEmail')]"
                  ]
                }
              }
            }
          ],
          "outputs": {
            "fabricCapacityName": {
              "type": "string",
              "value": "[parameters('fabricCapacityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "arm",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminEmail": {
            "value": "[parameters('adminEmail')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subscriptionId": {
            "value": "[subscription().subscriptionId]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "6848330669199151182"
            }
          },
          "parameters": {
            "adminEmail": {
              "type": "string"
            },
            "connections_arm_name": {
              "type": "string",
              "defaultValue": "arm"
            },
            "location": {
              "type": "string"
            },
            "subscriptionId": {
              "type": "string"
            },
            "tenantId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[parameters('connections_arm_name')]",
              "location": "[parameters('location')]",
              "kind": "V1",
              "properties": {
                "displayName": "[parameters('adminEmail')]",
                "statuses": [
                  {
                    "status": "Connected"
                  }
                ],
                "customParameterValues": {},
                "nonSecretParameterValues": {
                  "token:tenantId": "[parameters('tenantId')]",
                  "token:grantType": "code"
                },
                "createdTime": "2024-08-05T14:15:07.2117587Z",
                "changedTime": "2024-08-05T14:15:14.4079761Z",
                "api": {
                  "name": "[parameters('connections_arm_name')]",
                  "displayName": "Azure Resource Manager",
                  "description": "Azure Resource Manager exposes the APIs to manage all of your Azure resources.",
                  "iconUri": "[format('https://connectoricons-prod.azureedge.net/releases/v1.0.1685/1.0.1685.3700/{0}/icon.png', parameters('connections_arm_name'))]",
                  "brandColor": "#003056",
                  "id": "[format('/subscriptions/{0}/providers/Microsoft.Web/locations/{1}/managedApis/{2}', parameters('subscriptionId'), parameters('location'), parameters('connections_arm_name'))]",
                  "type": "Microsoft.Web/locations/managedApis"
                },
                "testLinks": []
              }
            }
          ],
          "outputs": {
            "connections_arm_name": {
              "type": "string",
              "value": "[parameters('connections_arm_name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "logicApp",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "fabricCapacityName": {
            "value": "[variables('fabricCapacityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logicAppName": {
            "value": "[variables('logicAppName')]"
          },
          "resourceGroupName": {
            "value": "[variables('resourceGroupName')]"
          },
          "subscriptionId": {
            "value": "[subscription().subscriptionId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "10273792894945524477"
            }
          },
          "parameters": {
            "fabricCapacityName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Fabric Capacity"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "logicAppName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Logic App"
              }
            },
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the resource group"
              }
            },
            "subscriptionId": {
              "type": "string",
              "metadata": {
                "description": "The subscription ID where the resources will be deployed"
              }
            },
            "connections_arm_externalid": {
              "type": "string",
              "defaultValue": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Web/connections/arm', parameters('subscriptionId'), parameters('resourceGroupName'))]",
              "metadata": {
                "description": "The external ID for the ARM connection"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[parameters('logicAppName')]",
              "location": "[parameters('location')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "interval": 1,
                        "frequency": "Day",
                        "timeZone": "GMT Standard Time",
                        "schedule": {
                          "hours": [
                            "21"
                          ]
                        }
                      },
                      "evaluatedRecurrence": {
                        "interval": 1,
                        "frequency": "Day",
                        "timeZone": "GMT Standard Time",
                        "schedule": {
                          "hours": [
                            "21"
                          ]
                        }
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Read_status_of_Fabric_Capacity": {
                      "runAfter": {},
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['arm']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "[format('/subscriptions/@{{encodeURIComponent(''{0}'')}}/resourcegroups/@{{encodeURIComponent(''{1}'')}}/providers/@{{encodeURIComponent(''Microsoft.Fabric'')}}/@{{encodeURIComponent(''capacities/{2}'')}}', parameters('subscriptionId'), parameters('resourceGroupName'), parameters('fabricCapacityName'))]",
                        "queries": {
                          "x-ms-api-version": "2023-11-01"
                        }
                      }
                    },
                    "Condition_Pause_Fabric_Capacity_if_not_Paused": {
                      "actions": {
                        "Invoke_resource_operation": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['arm']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "[format('/subscriptions/@{{encodeURIComponent(''{0}'')}}/resourcegroups/@{{encodeURIComponent(''{1}'')}}/providers/@{{encodeURIComponent(''Microsoft.Fabric'')}}/@{{encodeURIComponent(''capacities/{2}'')}}/@{{encodeURIComponent(''suspend'')}}', parameters('subscriptionId'), parameters('resourceGroupName'), parameters('fabricCapacityName'))]",
                            "queries": {
                              "x-ms-api-version": "2023-11-01"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Read_status_of_Fabric_Capacity": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {}
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@body('Read_status_of_Fabric_Capacity')?['properties']?['state']",
                                "Paused"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "arm": {
                        "id": "[format('/subscriptions/{0}/providers/Microsoft.Web/locations/{1}/managedApis/arm', parameters('subscriptionId'), parameters('location'))]",
                        "connectionId": "[parameters('connections_arm_externalid')]",
                        "connectionName": "arm"
                      }
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "logicAppName": {
              "type": "string",
              "value": "[parameters('logicAppName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'arm')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'fab')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ]
}